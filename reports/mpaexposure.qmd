---
title: "MPA Exposure Analysis"
format: 
  html:
    code-fold: true
editor: visual
---

```{r}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

------------------------------------------------------------------------

Code to characterize exposure of California MPAs to future pH, DO, and temperature using IPSL model predictions. Note: this setup is only for one projection (IPSL). Change every occurence of "IPSL" to "GFDL" or "HADLEY" in this report to do same for diff projection.

## Setup

Load libraries and read data. Convert DO units and filter for years 2090-2100.

```{r}
#| label: libraries
#| message: false

library(tidyverse)
library(lubridate)
library(data.table)
library(factoextra)
library(broom)
library(cowplot)
library(respR)
library(here)
library(lattice)
library(RcppRoll)
library(RColorBrewer)
library(gplots)
library(ggpmisc)
library(dendextend)
library(colourvalues)
library(zoo)
```

Load MPA name file and merge with model projection. Add time periods.

```{r}
#| label: load_data
#| message: false

#Read mpa data, convert DO units, add a column for time period, and one for difference between mid/end cen and historic.
mpa <- read_csv(here("data/processeddata/model/IPSLmpa.csv")) %>% 
  mutate(DO_mmolL = DO_surf/1000,
         DO_mgL = convert_DO(DO_mmolL, from = "mmol/L", to = "mg/L")) %>% 
  filter(Year <= 2020|
         Year >= 2040 & Year <= 2060|
         Year >= 2080 & Year <= 2100) %>%
  mutate(period = case_when((Year <= 2020) ~ "historic", 
                           (Year %in% c(2040:2060)) ~ "midcen",
                           (Year %in% c(2080:2100)) ~ "endcen")) %>%
  select(-T_bot, -DO_bot, -pH_bot,-DO_surf,-DO_mmolL) %>%
  rename(Temp = T_surf,
         DO = DO_mgL,
         pH = pH_surf) %>%
  mutate(Date = make_date(Year, Month, Day)) %>%
  mutate(julianday = yday(Date))

mpa$File <- substr(mpa$File, 1, nchar(mpa$File)-4)

```

Add regions

```{r}
#| label: regions
#| message: false
#add regions here!
mpa_centroids<- read_csv(here("data/rawdata/MPA_polygons.csv")) %>%
  select(-Area_sq_mi, -Type)
mpa_centroids$File <- sub("^", "tphdo_mpa_", mpa_centroids$OBJECTID )

mpa_centroids <- mpa_centroids %>%
  mutate(region = ifelse(degy >= 37.29, "norca", 
                         ifelse(degy > 34.8, "centralca", 
                                ifelse("degy" < 34.274 & "degx" < -119.220, "channelisl" , 
                                       "socal"))))

channel <- c("Anacapa Island FMCA", "Anacapa Island FMR", "Anacapa Island SMCA", "Anacapa Island SMR", "Anacapa Island Special Closure", 
             "Arrow Point to Lion Head Point SMCA", "Begg Rock SMR", "Blue Cavern Offshore SMCA", "Blue Cavern Onshore SMCA (No-Take)", 
             "Carrington Point SMR", "Casino Point SMCA (No-Take)", "Cat Harbor SMCA", "Farnsworth Offshore SMCA", "Farnsworth Onshore SMCA", 
             "Footprint FMR", "Footprint SMR", "Gull Island FMR", "Gull Island SMR", "Harris Point FMR", "Harris Point SMR", "Judith Rock SMR", 
             "Long Point SMR", "Loverâ€™s Cove SMCA", "Painted Cave SMCA", "Richardson Rock FMR", "Richardson Rock SMR", "San Miguel Island Special Closure", 
             "Santa Barbara Island FMR", "Santa Barbara Island SMR", "Scorpion FMR", "Scorpion SMR", "Skunk Point SMR", "South Point FMR", "South Point SMR")

mpa_centroids$region[mpa_centroids$NAME %in% channel]  <- "channel" 
mpa <- merge(mpa, mpa_centroids,  by = "File")

```

## Calculate climatology

Create a climatology (Jan averaged over every year), so each MPA has one value per month that is averaged over all of the years. Find SD of this dataframe, to get seasonal variation.

```{r}
#| label: clim_SD
#| message: false

#calculate climatology for each MPA for each time period
mpa_climatology <- mpa %>%
  group_by(File, Month, period) %>%
    summarise(T_clim = mean(Temp), 
              pH_clim = mean(pH), 
              DO_clim =   mean(DO))

#calculate seasonal SD 
seasonal_SD <- mpa_climatology %>%
  group_by(File, period) %>%
  summarise(T_seasonalSD = sd(T_clim),
            pH_seasonalSD = sd(pH_clim),
            DO_seasonalSD = sd(DO_clim))

#individual files per time period 
mpa_historic_climatology <- mpa %>% 
  filter(period == "historic") %>%
  group_by(File, Month) %>%
  summarise(T_clim = mean(Temp), T_clim_sd = sd(Temp), pH_clim = mean(pH), DO_clim =   mean(DO))

mpa_midcen_climatology <- mpa %>%
  filter(period == "midcen") %>%
  group_by(File, Month) %>%
  summarise(T_clim = mean(Temp), pH_clim = mean(pH), DO_clim = mean(DO))

mpa_endcen_climatology <- mpa %>%
  filter(period == "endcen") %>%
  group_by(File, Month) %>%
  summarise(T_clim = mean(Temp), pH_clim = mean(pH), DO_clim = mean(DO))

```

## Calculate event-based variation

Create a mock dataset interpolating climatologies to get daily values in the absence of natural event-based variability. Subtract actual daily values. Find standard deviation of these differences (on a daily scale).

Setup for interpolation:

```{r}
#| label: inter_setup
#| message: false
#| warning: false

#First: Need to create a day1 and day365 proxies. Approx function can only interpolate not extrapolate so without this, you can interpolate days 1-14 and 350-365. #below creates empty vectors as big as we need (365 days per mpa) for each variable and each mpa. julianday is dates 1-365 as many mpa times

mpaslist = unique(mpa$File) 
mpas = rep(NA, 365*121)
julianday = rep(1:365, 121)
T_clim = rep(NA, 365*121)
pH_clim = rep(NA, 365*121)
DO_clim = rep(NA, 365*121)

#Set up a vector of julian day assignment for the 15th of each month and the first and last day of the year
x_in <- yday(as.Date(c("2000-01-01", "2000-01-15","2000-02-15","2000-03-15","2000-04-15","2000-05-15","2000-06-15",
                       "2000-07-15","2000-08-15","2000-09-15","2000-10-15","2000-11-15","2000-12-15", "2000-12-31")))

# creating a list of all the days of the year not included in x_in to interpolate to.
x_out <- (1:365)
x_out <- x_out[!(x_out %in% x_in)] #removing the days of the year we already have values for
```

Interpolation for temp

```{r,warning=FALSE, message=FALSE, results='hide'}
#| label: inter_temp
#| message: false
#| warning: false

mpa_historic_climatology <- mpa_climatology %>%
  filter(period == "historic")

#HISTORIC
for (i in 1:length(mpaslist)){
  d = mpa_historic_climatology %>% filter(File == mpaslist[i]) %>% select(File,Month,T_clim)
  #use a weighted average to get these
  Dec31 = as.numeric(( ((16/30) * (d[12,3])) + ((14/30) * d[1,3]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,3])) + ((16/30) * d[1,3]) ))
  # a list of y-values of the climatological temp on each of the days in x_in
  y_in <- c(Jan1, d$T_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i] #rep(mpaslist[1], 365)
  T_clim[((i-1)*365+1):(i*365)] <- mod$y
}

historic_tempdata <- data.frame(mpas, julianday,T_clim) %>%
  rename(File = mpas) %>%
  mutate(period = "historic") %>%
  rename(interp_temp = T_clim)



#MIDCEN
mpa_midcen_climatology <- mpa_climatology %>%
  filter(period == "midcen")

for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_midcen_climatology %>% filter(File == mpaslist[i]) %>% select(T_clim)
  #use a weighted average to get these
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))
  # a list of y-values of the climatological temp on each of the days in x_in
  y_in <- c(Jan1, d$T_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i] #rep(mpaslist[1], 365)
  T_clim[((i-1)*365+1):(i*365)] <- mod$y
}

midcen_tempdata = data.frame(mpas, julianday,T_clim)
midcen_tempdata <- midcen_tempdata %>%
  rename(File = mpas) %>%
  mutate(period = "midcen") %>%
  rename(interp_temp = T_clim)


#ENDCEN
mpa_endcen_climatology <- mpa_climatology %>%
  filter(period == "endcen")

for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_endcen_climatology %>% filter(File == mpaslist[i]) %>% select(T_clim)
  #use a weighted average to get these
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))
  # a list of y-values of the climatological temp on each of the days in x_in
  y_in <- c(Jan1, d$T_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i] #rep(mpaslist[1], 365)
  T_clim[((i-1)*365+1):(i*365)] <- mod$y
}

endcen_tempdata = data.frame(mpas, julianday,T_clim)
endcen_tempdata <- endcen_tempdata %>%
  rename(File = mpas) %>%
  mutate(period = "endcen") %>%
  rename(interp_temp = T_clim)
  
```

Interpolation for pH

```{r, warning=FALSE, message=FALSE, results='hide'}
#| label: inter_pH
#| message: false
#| warning: false

#HISTORIC
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_historic_climatology %>% filter(File == mpaslist[i]) %>% select(pH_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))

  y_in <- c(Jan1, d$pH_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  pH_clim[((i-1)*365+1):(i*365)] <- mod$y
}

historic_pHdata = data.frame(mpas, julianday,pH_clim)
historic_pHdata <- historic_pHdata %>%
  rename(File = mpas) %>%
  mutate(period = "historic") %>%
  rename(interp_pH = pH_clim)

#MIDCEN
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_midcen_climatology %>% filter(File == mpaslist[i]) %>% select(pH_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))

  y_in <- c(Jan1, d$pH_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  pH_clim[((i-1)*365+1):(i*365)] <- mod$y
}

midcen_pHdata = data.frame(mpas, julianday,pH_clim)
midcen_pHdata <- midcen_pHdata %>%
  rename(File = mpas) %>%
  mutate(period = "midcen") %>%
  rename(interp_pH = pH_clim)

#ENDCEN
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_endcen_climatology %>% filter(File == mpaslist[i]) %>% select(pH_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))

  y_in <- c(Jan1, d$pH_clim, Dec31)

  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  pH_clim[((i-1)*365+1):(i*365)] <- mod$y
}

endcen_pHdata = data.frame(mpas, julianday,pH_clim)
endcen_pHdata <- endcen_pHdata %>%
  rename(File = mpas) %>%
  mutate(period = "endcen") %>%
  rename(interp_pH = pH_clim)


```

Interpolation for DO:

```{r,warning=FALSE, message=FALSE, results='hide'}
#| label: inter_DO
#| message: false
#| warning: false

#HISTORIC
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_historic_climatology %>% filter(File == mpaslist[i]) %>% select(DO_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))
  y_in <- c(Jan1, d$DO_clim, Dec31)
  
  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  DO_clim[((i-1)*365+1):(i*365)] <- mod$y
}

historic_DOdata = data.frame(mpas, julianday,DO_clim)
historic_DOdata <- historic_DOdata %>%
  rename(File = mpas) %>%
  mutate(period = "historic") %>%
  rename(interp_DO = DO_clim)

#MIDCEN
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_midcen_climatology %>% filter(File == mpaslist[i]) %>% select(DO_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))
  y_in <- c(Jan1, d$DO_clim, Dec31)
  
  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  DO_clim[((i-1)*365+1):(i*365)] <- mod$y
}

midcen_DOdata = data.frame(mpas, julianday,DO_clim)
midcen_DOdata <- midcen_DOdata %>%
  rename(File = mpas) %>%
  mutate(period = "midcen")  %>%
  rename(interp_DO = DO_clim)

#ENDCEN
for (i in 1:length(mpaslist)){
  print(i)
  d = mpa_endcen_climatology %>% filter(File == mpaslist[i]) %>% select(DO_clim)
  Dec31 = as.numeric(( ((16/30) * (d[12,2])) + ((14/30) * d[1,2]) ))
  Jan1 = as.numeric(( ((14/30) * (d[12,2])) + ((16/30) * d[1,2]) ))
  y_in <- c(Jan1, d$DO_clim, Dec31)
  
  mod = approx(x = x_in, y = y_in, xout = x_out) 
  mpas[((i-1)*365+1):(i*365)] <- mpaslist[i]
  DO_clim[((i-1)*365+1):(i*365)] <- mod$y
}

endcen_DOdata = data.frame(mpas, julianday,DO_clim)
endcen_DOdata <- endcen_DOdata %>%
  rename(File = mpas) %>%
  mutate(period = "endcen")  %>%
  rename(interp_DO = DO_clim)
```

## Create summary stats

Merge interpolated values to MPA dataset to find seasonal SD (SD of deviation between daily value and interpolated climatological value). Add other summary stats like event SD, mean, lower 10, upper 10 percentile.

```{r}
#| label: summary_stats

#merging interpolated datasets from prev chunks
interpolated_temp <- rbind(historic_tempdata,midcen_tempdata,endcen_tempdata)
interpolated_pH <- rbind(historic_pHdata, midcen_pHdata, endcen_pHdata)
interpolated_DO <- rbind(historic_DOdata, midcen_DOdata, endcen_DOdata)

sum <- mpa %>%
 
  #merge interpolated climatologies to mpa. (used to calculate event sd)
  merge(interpolated_temp, by = c("File", "julianday", "period")) %>%
  merge(interpolated_pH, by = c("File", "julianday", "period")) %>%
  merge(interpolated_DO, by = c("File", "julianday", "period")) %>%
  
  #subtract actual values - interpolated climatology values 
  #filtered for only upwelling months!!
  mutate(temp_deviation = Temp - interp_temp,
         pH_deviation = pH - interp_pH,
         DO_deviation = DO - interp_DO) %>%
  filter(Month == c(5,6,7,8,9)) %>%
  
  #find event based SD 
  group_by(File, period) %>%
    mutate(T_eventSD = sd(temp_deviation),
            pH_eventSD = sd(pH_deviation),
            DO_eventSD = sd(DO_deviation)) %>%
    select(-interp_temp, -interp_pH, -interp_DO, -temp_deviation,
         -pH_deviation, -DO_deviation) %>%
  
    #merge seasonal SD calculated earlier from climatologies
    merge(seasonal_SD, by = c("File", "period")) %>%
  
    #adding other summary stats - mean, low 10th and upper 10th percentiles
    group_by(File, period) %>%
    mutate(across(c(Temp, DO, pH), 
                   list(mean = mean, 
                        low10 = ~ quantile(.x, 0.1),
                        high10 = ~quantile(.x,0.9)))) %>%
  
  # to get to scale of one row per mpa
  select(-...1, -Temp, -pH, -DO, -julianday, -Year, -Month, -Day) %>%
  distinct(File, .keep_all = TRUE) %>% ungroup()

```

## PCA

PCA with all summary stats (mean, lower 10th percentile, seasonal SD, event SD)

```{r}
#| label: pca


make_pca <- function(df, periodt){
  sum_period <- df %>% filter(period == periodt) 
  sumsub <- sum_period %>% select(-OBJECTID,-NAME, -File, -SHORTNAME, -degx, 
                                  -degy, -region, -period, -Date) 
  
  pca <- prcomp(sumsub, scale = TRUE)
  
  plot <- fviz_pca_biplot(pca, repel = TRUE,
                  col.var = "black",
                  col.ind = sum_period$region,
                  label ="var",
                  labelsize = 3,
                  addEllipses = TRUE,
                  title = periodt) 
  #fviz_pca_ind(pca, label="none", habillage=sum_period$region,
               #addEllipses=TRUE,  col.ind = sum_period$region)
  
  ggsave(here(paste("./figs/pca/pca",periodt,".png")), plot)
}

make_pca(sum, "historic")
make_pca(sum, "midcen")
make_pca(sum, "endcen") #need to rotate by changing sumsub to sumsub[,-1] inside prcomp


```

## Heatmaps by variable

```{r}

col <- colorRampPalette(brewer.pal(9,"YlOrRd"))(256)
invert_col <- colorRampPalette(rev(brewer.pal(9,"YlOrRd")))(256)


make_heatmap <- function(df, sumstat, color_palette = invert_col){
  
  #make matrix for variable of interest
  matrix <- df %>%
  select(sumstat, NAME, degy, period, region) %>%
  pivot_wider(names_from = period, values_from = sumstat) %>%
  mutate(col = case_when((region == "centralca") ~ "#ffff99", 
                             (region == "norca") ~ "#beaed4",
                             (region == "socal") ~ "#fdc086",
                             (region == "channel") ~ "#7fc97f")) %>%
  arrange(degy) 

  #making matrix numeric for heatmap to work
  matrix_numeric <- matrix %>%
  select(-NAME, -region, -degy, -col) %>%
  select(historic, midcen, endcen) %>%
  as.matrix()

  row.names(matrix_numeric) <- matrix$NAME

  jpeg(file=here(paste("./figs/heatmap/heatmap",sumstat,".jpeg")), res = 100)
  heatmap.2(matrix_numeric, Rowv = FALSE, Colv = FALSE, dendrogram = "none", 
          main = sumstat, tracecol=NA, revC= TRUE,
          margins = c(5,10), col= color_palette, srtCol = 45, 
          labRow = matrix$NAME, RowSideColors = matrix$col)
  dev.off()

  
  #can try adding an if statement, if argument for save = true, then save file. default is false.
}

#Temp heatmaps
make_heatmap(sum, "Temp_mean", col)
make_heatmap(sum, "Temp_high10", col)
make_heatmap(sum, "Temp_low10", col)
make_heatmap(sum, "T_eventSD", col)
make_heatmap(sum, "T_seasonalSD", col)

#pH heatmaps
make_heatmap(sum, "pH_mean")
make_heatmap(sum, "pH_high10")
make_heatmap(sum, "pH_low10")
make_heatmap(sum, "pH_eventSD")
make_heatmap(sum, "pH_seasonalSD")

#DO heatmaps
make_heatmap(sum, "DO_mean")
make_heatmap(sum, "DO_high10")
make_heatmap(sum, "DO_low10")
make_heatmap(sum, "DO_eventSD")
make_heatmap(sum, "DO_seasonalSD")


```

## Regressions

Supplementing heatmaps by looking at correlation between historic and future time periods for a given summary stat

```{r}

make_regression <- function(df, sumstat, period1, period2){
 plot_matrix <- df %>%
   filter(period == period1 | period == period2) %>%
   select(sumstat, period, NAME, File) %>%
   pivot_wider(names_from = period, values_from = sumstat) 
 
 plot <- ggplot(data = plot_matrix, aes_string(x = period1, y = period2)) +
   stat_poly_line() +
   stat_poly_eq(use_label(c("eq", "R2"))) +
   geom_point() +
   theme_classic() +
   ggtitle(sumstat)
 
  ggsave(here(paste("./figs/regression/regression",sumstat,period2,".png")), plot)

}

#temp
make_regression(sum, "Temp_mean", "historic", "midcen")
make_regression(sum, "Temp_mean", "historic", "endcen")
make_regression(sum, "T_seasonalSD", "historic", "midcen")
make_regression(sum, "T_seasonalSD", "historic", "endcen")
make_regression(sum, "T_eventSD", "historic", "midcen")
make_regression(sum, "T_eventSD", "historic", "endcen")

#pH
make_regression(sum, "pH_mean", "historic", "midcen")
make_regression(sum, "pH_mean", "historic", "endcen")
make_regression(sum, "pH_seasonalSD", "historic", "midcen")
make_regression(sum, "pH_seasonalSD", "historic", "endcen")
make_regression(sum, "pH_eventSD", "historic", "midcen")
make_regression(sum, "pH_eventSD", "historic", "endcen")

#DO
make_regression(sum, "DO_mean", "historic", "midcen")
make_regression(sum, "DO_mean", "historic", "endcen")
make_regression(sum, "DO_seasonalSD", "historic", "midcen")
make_regression(sum, "DO_seasonalSD", "historic", "endcen")
make_regression(sum, "DO_eventSD", "historic", "midcen")
make_regression(sum, "DO_eventSD", "historic", "endcen")

```

## Anomalous pH/DO Event Analysis

Find percentage of unsaturated/ low DO days over all years using a biological threshold. Separated by upwelling and non-upwelling months. Output is used to make maps in QGIS.

```{r}
# Create labels for events (e.g., consecutive days with low pH or low DO) using run 
# length encoding

label_events <- function(is_event) {
  event_rle <- rle(is_event)
  labels <- ifelse(event_rle$values, cumsum(event_rle$values), NA)
  rep(labels, event_rle$lengths)
}

#all event categorization for pH and DO
events <- mpa %>%
  group_by(period) %>%
  select(File, Date, Year,NAME, pH, DO, period, degx, degy, julianday) %>%
  mutate(is_pH_low = pH < 7.75,
         pH_event = label_events(is_pH_low),
        
         is_DO_low = DO < 4.6,
         DO_event = label_events(is_DO_low),
         
         is_pH_and_DO_low = ifelse(is_pH_low == TRUE & is_DO_low == TRUE, TRUE, FALSE),
         pH_and_DO_event = label_events(is_pH_and_DO_low)) 
```

pH:

```{r}
#pH event summary
pH_event_summary <- events %>%
  filter(is_pH_low == TRUE) %>% 
  select(-DO_event, -DO, -is_DO_low, -is_pH_and_DO_low, -pH_and_DO_event) %>%
  group_by(File, pH_event) %>% 
  mutate(duration_days = n(),
         event_begin = min(Date),
         event_mean = mean(pH), #mean during the individual event 
         intensity = 7.75 - event_mean,
         severity = intensity*duration_days) %>%
  ungroup() %>%

  #mpa summary (across periods)
  group_by(File, period) %>%
  mutate(num_event = n_distinct(pH_event), 
         mean_event_duration = mean(duration_days),  
         max_event_duration = max(duration_days),
         mean_event_mean_pH = mean(event_mean), 
         mean_event_intensity = mean(intensity),
         mean_event_severity = mean(severity)) %>%
  ungroup() %>%

  #mpa summary (annual)
  group_by(File, Year) %>%
  mutate(annual_days_belowthresh = n(), annual_avg_ph_belowthresh = mean(pH)) %>%
  ungroup() %>%
  group_by(File) %>%
  mutate(meanannual_days_belowthresh = mean(annual_days_belowthresh),
         meanannual_avg_pH_belowthresh = mean(annual_avg_ph_belowthresh)) 
  
#now removing event-scale variables not needed to condense to mpa scale
pH_mpa_summary <- pH_event_summary %>%
  select(-duration_days, -event_begin, -event_mean, -intensity, 
         -severity, -is_pH_low,-pH_event, -julianday) %>%
  distinct(period, File, .keep_all = TRUE) 

#used later
pH_all_events <- left_join(events, pH_event_summary,
                         by = c("File", "Date", "Year", "NAME", "pH", "period", 
                                "degx", "degy", "julianday", "is_pH_low", "pH_event"))
```

DO:

```{r}
#DO event summary
DO_event_summary <- events %>%
  filter(is_DO_low == TRUE) %>% 
  select(-pH_event, -pH, -is_pH_low, -is_pH_and_DO_low, -pH_and_DO_event) %>%
  group_by(File, DO_event) %>% 
  mutate(duration_days = n(),
         event_begin = min(Date),
         event_mean = mean(DO), #mean during the individual event 
         intensity = 7.75 - event_mean,
         severity = intensity*duration_days) %>%
  ungroup() %>%

  #mpa summary (across periods)
  group_by(File, period) %>%
  mutate(num_event = n_distinct(DO_event), 
         mean_event_duration = mean(duration_days),  
         max_event_duration = max(duration_days),
         mean_event_mean_pH = mean(event_mean), 
         mean_event_intensity = mean(intensity),
         mean_event_severity = mean(severity)) %>%
  ungroup() %>%

  #mpa summary (annual)
  group_by(File, Year) %>%
  mutate(annual_days_belowthresh = n(), annual_avg_DO_belowthresh = mean(DO)) %>%
  ungroup() %>%
  group_by(File) %>%
  mutate(meanannual_days_belowthresh = mean(annual_days_belowthresh),
         meanannual_avg_DO_belowthresh = mean(annual_avg_DO_belowthresh)) 
  
#now removing event-scale variables not needed to condense to mpa scale
DO_mpa_summary <- DO_event_summary %>% 
  select(-duration_days, -event_begin, -event_mean, -intensity, 
         -severity, -is_DO_low, -DO_event, -julianday) %>%
   distinct(File, period, .keep_all = TRUE)

#used later
DO_all_events <- left_join(events, DO_event_summary,
                         by = c("File", "Date", "Year", "NAME", "DO", "period", 
                                "degx", "degy", "julianday", "is_DO_low", "DO_event"))
```

## Anomalous temp analysis

Categorized as anomalous event if temp exceeds historical climatology's temp for that month + 2\* hist clim sd

```{r}
#temp:
mpa_with_histclimsd <- mpa %>%
  filter(period == "historic") %>%
  group_by(File, Month) %>%
  summarise(hist_T_clim = mean(Temp), hist_T_clim_sd = sd(Temp)) %>% #this sd is temp over all days in Jan - rather than average of each jan's SD - does it make a difference? 
  merge(mpa, by = c("File", "Month"))

temp_event_summary <- mpa_with_histclimsd %>% 
  group_by(period) %>%
  select(File, Date, Year,NAME, Temp, hist_T_clim, hist_T_clim_sd, period, 
         degx, degy, julianday) %>%
  mutate(is_temp_high = Temp > (hist_T_clim + 2*hist_T_clim_sd),
         temp_event = label_events(is_temp_high)) %>%
  
  filter(is_temp_high == TRUE) %>%
  group_by(File, temp_event) %>% 
  mutate(duration_days = n(),
         event_begin = min(Date),
         event_mean = mean(Temp),  
         intensity = Temp - (hist_T_clim + 2*hist_T_clim_sd),
         severity = intensity*duration_days) %>%
  ungroup() %>%

  #mpa summary (across periods)
  group_by(File, period) %>%
  mutate(num_event = n_distinct(temp_event), 
         mean_event_duration = mean(duration_days),  
         max_event_duration = max(duration_days),
         mean_event_mean_temp = mean(event_mean), 
         mean_event_intensity = mean(intensity),
         mean_event_severity = mean(severity)) %>%
  ungroup() %>%
  
  #mpa summary (annual)
  group_by(File, Year) %>%
  mutate(annual_days_abovethresh = n(), 
         annual_avg_temp_abovethresh = mean(Temp)) %>%
  ungroup() %>%
  group_by(File) %>%
  mutate(meanannual_days_abovethresh = mean(annual_days_abovethresh),
         meanannual_avg_temp_abovethresh = mean(annual_avg_temp_abovethresh)) 
  
  #now removing event-scale variables not needed to condense to mpa scale
temp_mpa_summary <- temp_event_summary %>% 
  select(-Temp,-duration_days, -event_begin, -event_mean, -intensity, 
         -severity, -is_temp_high, -temp_event, -julianday) %>%
  distinct(period, File, .keep_all = TRUE)

#used later
temp_all_events <- left_join(mpa, temp_event_summary,
                         by = c("File", "Date", "Year", "NAME", "Temp", "period", 
                                "degx", "degy", "julianday"))
```

## Severity, Intensity, Duration

```{r}

#sev-int-dur - not function :(
historic_sevintdur_ano <- temp_all_events %>%
    filter(period == "endcen", NAME == "Soquel Canyon SMCA") %>%
    ggplot(aes(julianday, Year, fill = intensity)) +
    geom_tile() +
    scale_fill_distiller(palette = "YlOrRd", direction = 1, na.value = "skyblue") +
    theme_classic() +
    ggtitle("End Cen Soquel Canyon SMCA")

#central
ggsave(here("./figs/sevintdur/central/sevintdur_endcen_soquelcanyon.png"), historic_sevintdur_ano)




#intensity/severity/duration function (takes AGES TO LOAD) - try not taking in anom_all_events, instead creating this inside the function. 

make_sev_int_dur <- function(anom_all_events, periodt, site){
  anom_all_events %>%
    filter(period == periodt, NAME == site) %>%
    ggplot(aes(julianday, Year, fill = intensity)) +
    geom_tile() +
    scale_fill_distiller(palette = "YlOrRd", direction = 1, na.value = "skyblue") +
    theme_classic() +
    ggtitle(paste(anom_all_events, periodt, site))
  
    ggsave(here(paste("./figs/sevintdur/sevintdur",anom_all_events,periodt,site,".png")), plot)

}
make_sev_int_dur(DO_all_events, "historic", "Ano Nuevo SMR")



```

## Time series to put in context

```{r}

#this fig shows time series in julian days w/ envelope wrt given period's SD (NOT historic, as it should be for calculating anomalous event!)

make_temp_time_series <- function(df, periodt, site){

df %>% 
  filter(period == periodt, 
         NAME == site) %>%
  mutate(sliding_sd = roll_sd(Temp, 30, fill = NA)) %>% 
  group_by(julianday) %>%
  mutate(clim_mean = mean(Temp, na.rm = TRUE),
         clim_sd = mean(sliding_sd, na.rm = TRUE),
         clim_upr = clim_mean + 2 * clim_sd,
         clim_lwr = clim_mean - 2 * clim_sd) %>% 
  ungroup() %>%
  
  ggplot(aes(julianday)) +
  geom_ribbon(aes(ymin = clim_lwr, ymax = clim_upr),
              fill = "black", alpha = 0.75) +
  geom_line(aes(y = Temp, color = Year, group = Year),
            alpha = 0.5) +
  geom_line(aes(y = clim_mean), size = 1, color = "blue") +
  scale_color_viridis_c() +
  theme_classic() 
}

make_pH_time_series <- function(df, periodt, site){

df %>% 
  filter(period == periodt, 
         NAME == site) %>%
  mutate(sliding_sd = roll_sd(pH, 30, fill = NA)) %>% 
  group_by(julianday) %>%
  mutate(clim_mean = mean(pH, na.rm = TRUE),
         clim_sd = mean(sliding_sd, na.rm = TRUE),
         clim_upr = clim_mean + 2 * clim_sd,
         clim_lwr = clim_mean - 2 * clim_sd) %>% 
  ungroup() %>%
  
  ggplot(aes(julianday)) +
  geom_ribbon(aes(ymin = clim_lwr, ymax = clim_upr),
              fill = "black", alpha = 0.75) +
  geom_line(aes(y = pH, color = Year, group = Year),
            alpha = 0.5) +
  geom_line(aes(y = clim_mean), size = 1, color = "blue") +
  scale_color_viridis_c() +
  theme_classic() 
}

make_DO_time_series <- function(df, periodt, site){

df %>% 
  filter(period == periodt, 
         NAME == site) %>%
  mutate(sliding_sd = roll_sd(DO, 30, fill = NA)) %>% 
  group_by(julianday) %>%
  mutate(clim_mean = mean(DO, na.rm = TRUE),
         clim_sd = mean(sliding_sd, na.rm = TRUE),
         clim_upr = clim_mean + 2 * clim_sd,
         clim_lwr = clim_mean - 2 * clim_sd) %>% 
  ungroup() %>%
  
  ggplot(aes(julianday)) +
  geom_ribbon(aes(ymin = clim_lwr, ymax = clim_upr),
              fill = "black", alpha = 0.75) +
  geom_line(aes(y = DO, color = Year, group = Year),
            alpha = 0.5) +
  geom_line(aes(y = clim_mean), size = 1, color = "blue") +
  scale_color_viridis_c() +
  theme_classic() 
}



make_temp_time_series(mpa, "historic","Ano Nuevo SMR") 
make_pH_time_series(mpa, "historic","Ano Nuevo SMR") 
make_DO_time_series(mpa, "historic","Ano Nuevo SMR") 


```

Making figs (severity/intensity/duration and time series for individual MPAs

```{r}

```
